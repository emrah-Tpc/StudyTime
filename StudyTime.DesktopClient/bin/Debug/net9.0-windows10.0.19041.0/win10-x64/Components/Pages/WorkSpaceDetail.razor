@page "/work/{LessonId:guid}"
@using StudyTime.Application.DTOs.Tasks
@using StudyTime.Application.DTOs.Lessons
@inject StudyTime.DesktopClient.Services.LessonApiService LessonService
@inject StudyTime.DesktopClient.Services.TaskApiService TaskService
@inject StudyTime.DesktopClient.Services.GlobalTimerService TimerService
@inject NavigationManager NavManager
@implements IDisposable

<div class="detail-container">
    <div class="top-header">
        <button class="btn-back" @onclick="GoBack">← Back</button>
        <h2>@(CurrentLesson?.Name ?? "Loading...")</h2>
    </div>

    <div class="split-view">
        <div class="timer-area">
            <div class="timer-circle" style="border-color: @(CurrentLesson?.Color ?? "#333")">
                <span class="timer-label">@(TimerService.IsPaused ? "PAUSED" : "FOCUS")</span>
                <span class="timer-value">@TimerService.ElapsedTime.ToString(@"hh\:mm\:ss")</span>
            </div>

            <div class="timer-controls">
                @if (!TimerService.IsRunning || TimerService.IsPaused)
                {
                    <button class="btn-ctrl start" style="background-color: @(CurrentLesson?.Color ?? "#333")"
                            @onclick="StartSession">
                        @(TimerService.IsPaused ? "RESUME" : "START")
                    </button>
                }
                else
                {
                    <button class="btn-ctrl pause" @onclick="TimerService.Pause">PAUSE</button>
                }

                @if (TimerService.IsRunning || TimerService.IsPaused)
                {
                    <button class="btn-ctrl stop" @onclick="StopSession">FINISH</button>
                }
            </div>
        </div>

        <div class="tasks-area">
            <div class="tasks-header">
                <h3>To-Do List</h3>
                <button class="btn-add-task" @onclick="() => IsDrawerOpen = true">+ Add Task</button>
            </div>

            <div class="task-list">
                @if (Tasks == null)
                {
                    <p>Loading tasks...</p>
                }
                else if (Tasks.Count == 0)
                {
                    <div class="empty-state">No active tasks. Add one to start!</div>
                }
                else
                {
                    @foreach (var task in Tasks.Where(t => t.Status != StudyTime.Domain.Enums.TaskStatus.Completed))
                    {
                        <div class="task-row">
                            <input type="checkbox" @onchange="() => CompleteTask(task)" />
                            <div class="task-info">
                                <div class="task-title">@task.Title</div>
                                @if (task.PlannedDuration.HasValue)
                                {
                                    <span class="task-meta">⏱ @task.PlannedDuration.Value.TotalMinutes min</span>
                                }
                            </div>
                            <button class="btn-play-task" @onclick="() => StartTaskSession(task)">▶</button>
                        </div>
                    }
                }
            </div>
        </div>
    </div>
</div>

<div class="drawer-backdrop @(IsDrawerOpen ? "visible" : "")" @onclick="() => IsDrawerOpen = false"></div>
<div class="drawer-panel @(IsDrawerOpen ? "open" : "")">
    <div class="drawer-header">
        <h3>New Task</h3>
        <button class="btn-close-drawer" @onclick="() => IsDrawerOpen = false">✕</button>
    </div>

    <div class="drawer-body">
        <label>Task Title</label>
        <input type="text" @bind="NewTask.Title" placeholder="What needs to be done?" />

        <label>Notes</label>
        <textarea @bind="NewTask.Note" rows="4" placeholder="Add details..."></textarea>

        <label>Planned Duration (Min)</label>
        <input type="number" @bind="NewTask.PlannedMinutes" />
    </div>

    <div class="drawer-footer">
        <button class="btn-submit-task" @onclick="SaveTask">Save Task</button>
    </div>
</div>

@code {
    [Parameter] public Guid LessonId { get; set; }

    private LessonListItemDto? CurrentLesson;
    private List<TaskDto> Tasks = new();
    private bool IsDrawerOpen = false;

    // UI Model for Task Creation
    private class TaskFormModel
    {
        public string Title { get; set; } = "";
        public string Note { get; set; } = "";
        public int? PlannedMinutes { get; set; }
    }
    private TaskFormModel NewTask = new();

    protected override async Task OnInitializedAsync()
    {
        TimerService.OnTick += UpdateTimerUI;

        // 1. Backend'de GetById olmadığı için listeden buluyoruz
        var allLessons = await LessonService.GetAllAsync();
        CurrentLesson = allLessons.FirstOrDefault(l => l.Id == LessonId);

        await LoadTasks();
    }

    private async Task LoadTasks()
    {
        Tasks = await TaskService.GetTasksByLessonIdAsync(LessonId);
    }

    private async Task StartSession()
    {
        if (CurrentLesson != null)
        {
            await TimerService.StartAsync(LessonId, null, CurrentLesson.Color);
        }
    }

    private async Task StartTaskSession(TaskDto task)
    {
        if (CurrentLesson != null)
        {
            await TimerService.StartAsync(LessonId, task.Id, CurrentLesson.Color);
        }
    }

    private async Task StopSession()
    {
        await TimerService.StopAsync();
    }

    private async Task SaveTask()
    {
        if (string.IsNullOrWhiteSpace(NewTask.Title)) return;

        var dto = new CreateTaskDto
        {
            Title = NewTask.Title,
            Note = NewTask.Note,
            PlannedDurationMinutes = NewTask.PlannedMinutes,
            LessonId = LessonId,
            StartDate = DateTime.Now
        };

        await TaskService.CreateAsync(dto);
        IsDrawerOpen = false;
        NewTask = new();
        await LoadTasks();
    }

    private async Task CompleteTask(TaskDto task)
    {
        await TaskService.ToggleCompleteAsync(task.Id);
        Tasks.Remove(task); // UI'dan anlık kaldır
    }

    private void GoBack() => NavManager.NavigateTo("/work");

    private void UpdateTimerUI() => InvokeAsync(StateHasChanged);

    public void Dispose()
    {
        TimerService.OnTick -= UpdateTimerUI;
    }
}