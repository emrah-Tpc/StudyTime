@page "/work"
@using StudyTime.Application.DTOs.Lessons
@using StudyTime.Domain.Enums
@inject StudyTime.DesktopClient.Services.LessonApiService LessonService
@inject NavigationManager NavManager

<div class="work-container">
    <div class="page-header">
        <div>
            <h1>Workspaces</h1>
            <p class="subtitle">Focus on what matters.</p>
        </div>
        <button class="btn-primary" @onclick="() => IsModalOpen = true">+ Create Area</button>
    </div>

    @if (IsLoading)
    {
        <div class="loading">Loading workspaces...</div>
    }
    else
    {
        <div class="grid-layout">
            @foreach (var lesson in Lessons)
            {
                <div class="card" @onclick="() => GoToDetail(lesson.Id)" style="border-left-color: @lesson.Color">
                    <div class="card-content">
                        <h3>@lesson.Name</h3>
                        <span class="badge">@lesson.Type</span>
                    </div>
                    <button class="btn-delete" @onclick:stopPropagation="true" @onclick="() => DeleteLesson(lesson)">
                        🗑️
                    </button>
                </div>
            }
        </div>
    }
</div>

@if (IsModalOpen)
{
    <div class="modal-backdrop">
        <div class="modal-content">
            <div class="modal-header">
                <h2>New Workspace</h2>
                <button class="btn-close" @onclick="() => IsModalOpen = false">✕</button>
            </div>

            <div class="modal-body">
                <label>Title</label>
                <input type="text" @bind="TempModel.Name" placeholder="e.g. Mathematics" />

                <label>Category</label>
                <select @bind="TempModel.Type">
                    <option value="@LessonType.Academic">Academic</option>
                    <option value="@LessonType.Academic">Hobby / Project</option>
                </select>

                <label>Color Theme</label>
                <div class="color-options">
                    @foreach (var color in AvailableColors)
                    {
                        <div class="color-circle @(TempModel.Color == color ? "active" : "")"
                             style="background-color: @color"
                             @onclick="() => TempModel.Color = color">
                        </div>
                    }
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn-save" @onclick="CreateLesson">Create</button>
            </div>
        </div>
    </div>
}

@code {
    private List<LessonListItemDto> Lessons = new();
    private bool IsLoading = true;
    private bool IsModalOpen = false;
    private string[] AvailableColors = { "#5D5FEF", "#F43F5E", "#10B981", "#F59E0B", "#111827", "#8B5CF6" };

    // Backend DTO 'init' olduğu için UI için geçici model
    private class LessonFormModel
    {
        public string Name { get; set; } = "";
        public string Color { get; set; } = "#5D5FEF";
        public LessonType Type { get; set; } = LessonType.Academic;
    }
    private LessonFormModel TempModel = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        IsLoading = true;
        Lessons = await LessonService.GetAllAsync();
        IsLoading = false;
    }

    private async Task CreateLesson()
    {
        if (string.IsNullOrWhiteSpace(TempModel.Name)) return;

        var dto = new CreateLessonDto
        {
            Name = TempModel.Name,
            Color = TempModel.Color,
            Type = TempModel.Type
        };

        await LessonService.CreateAsync(dto);
        IsModalOpen = false;
        TempModel = new(); // Reset
        await LoadData();
    }

    private async Task DeleteLesson(LessonListItemDto lesson)
    {
        // ÇÖZÜM: Shell.Current kullanmak en güvenli yoldur.
        bool confirm = await Shell.Current.DisplayAlert("Confirm", "Archive this workspace?", "Yes", "No");

        if (confirm)
        {
            await LessonService.DeleteAsync(lesson.Id);
            Lessons.Remove(lesson);
            // UI güncellemesi gerekebilir, Blazor StateHasChanged'i otomatik yapmazsa:
            // StateHasChanged();
        }
    }

    private void GoToDetail(Guid id)
    {
        NavManager.NavigateTo($"/work/{id}");
    }
}