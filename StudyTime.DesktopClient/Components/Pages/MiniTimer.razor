@inject StudyTime.DesktopClient.Services.GlobalTimerService TimerService
@inject NavigationManager NavManager
@implements IDisposable

@if (TimerService.IsRunning && !IsOnDetailPage)
{
    <div class="mini-timer-card" @onclick="NavigateToSession" style="background-color: @TimerService.ActiveColor">
        <div class="status-dot"></div>
        <span class="time-text">@TimerService.ElapsedTime.ToString(@"hh\:mm\:ss")</span>
        <span class="hover-text">Go to Session</span>
    </div>
}

@code {
    private bool IsOnDetailPage =>
        TimerService.ActiveLessonId.HasValue &&
        NavManager.Uri.Contains($"/work/{TimerService.ActiveLessonId}");

    protected override void OnInitialized()
    {
        TimerService.OnTick += UpdateState;
        NavManager.LocationChanged += HandleNav;
    }

    private void UpdateState() => InvokeAsync(StateHasChanged);
    private void HandleNav(object? s, LocationChangedEventArgs e) => InvokeAsync(StateHasChanged);

    private void NavigateToSession()
    {
        if (TimerService.ActiveLessonId.HasValue)
        {
            NavManager.NavigateTo($"/work/{TimerService.ActiveLessonId}");
        }
    }

    public void Dispose()
    {
        TimerService.OnTick -= UpdateState;
        NavManager.LocationChanged -= HandleNav;
    }
}